# 拖拽报表生成功能设计说明书

## 1. 项目概述

### 1.1 项目背景
基于现有的AI报表生成系统，新增拖拽式报表设计功能，允许用户通过可视化拖拽界面快速创建和配置报表，支持绑定SQLite数据源，实现报表的灵活设计和数据展示。

### 1.2 项目目标
- 提供直观的拖拽式报表设计界面
- 支持SQLite数据源的绑定和配置
- 实现报表配置的保存、加载和删除
- 支持报表预览功能
- 提供完整的报表管理功能

### 1.3 技术栈
- **前端框架**: React 17.0.2
- **UI组件库**: Ant Design 4.24.13
- **拖拽布局库**: react-grid-layout 1.3.4
- **HTTP客户端**: Axios 1.8.4
- **路由**: React Router DOM 5.3.4
- **后端框架**: Flask (Python)
- **数据库**: SQLite
- **图表库**: @ant-design/charts 1.4.1

## 2. 功能需求

### 2.1 核心功能

#### 2.1.1 报表设计器
- **拖拽布局**: 支持通过拖拽方式调整报表组件的位置和大小
- **组件库**: 提供数据表格、图表、文本等组件类型
- **布局管理**: 支持12列网格布局系统，组件可自由拖拽和调整大小

#### 2.1.2 数据源配置
- **数据源选择**: 支持选择SQLite数据库作为数据源
- **表选择**: 从数据源中选择需要查询的数据表
- **字段配置**: 选择需要展示的字段，支持字段别名设置
- **筛选条件**: 支持添加多个筛选条件，包括字段、操作符和值

#### 2.1.3 报表管理
- **创建报表**: 创建新的报表配置
- **编辑报表**: 编辑已存在的报表配置
- **删除报表**: 删除不需要的报表
- **报表列表**: 查看所有已保存的报表

#### 2.1.4 报表预览
- **实时预览**: 根据配置的数据源和查询条件预览报表数据
- **数据展示**: 使用现有的ReportDisplay组件展示查询结果

### 2.2 功能特性

#### 2.2.1 布局配置
- 使用react-grid-layout实现可拖拽的网格布局
- 支持12列网格系统
- 组件可自由调整大小和位置
- 布局配置自动保存

#### 2.2.2 查询配置
- 支持多表查询（当前版本主要支持单表）
- 支持字段选择和别名设置
- 支持多种筛选操作符（=, !=, >, <, >=, <=, LIKE）
- 查询配置自动生成SQL语句

#### 2.2.3 数据安全
- SQL注入防护：只允许SELECT查询
- 禁止危险SQL关键字（DROP, DELETE, UPDATE等）
- 参数化查询防止SQL注入

## 3. 系统架构

### 3.1 整体架构

```
┌─────────────────────────────────────────────────────────┐
│                     前端层 (React)                        │
├─────────────────────────────────────────────────────────┤
│  ReportDesignerPage  │  ReportBuilder  │  ReportDisplay  │
│  (报表管理页面)        │  (报表设计器)    │  (报表展示)     │
└─────────────────────────────────────────────────────────┘
                            │
                            │ HTTP API
                            ▼
┌─────────────────────────────────────────────────────────┐
│                   后端层 (Flask)                         │
├─────────────────────────────────────────────────────────┤
│  ReportService  │  DatabaseService  │  QueryService     │
│  (报表服务)      │  (数据库服务)      │  (查询服务)        │
└─────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────┐
│                   数据层 (SQLite)                        │
├─────────────────────────────────────────────────────────┤
│  report_configs  │  users  │  orders  │  products        │
│  (报表配置表)     │  (用户表) │  (订单表) │  (产品表)        │
└─────────────────────────────────────────────────────────┘
```

### 3.2 模块划分

#### 3.2.1 前端模块

**ReportDesignerPage.js**
- 报表列表展示
- 报表创建、编辑、删除操作
- 路由管理

**ReportBuilder.js**
- 报表设计器主组件
- 数据源配置
- 组件拖拽布局
- 报表预览和保存

**api.js**
- 报表相关API接口封装
- HTTP请求处理

#### 3.2.2 后端模块

**report_service.py**
- 报表配置的CRUD操作
- 报表查询执行
- SQL生成和验证

**database_service.py**
- 数据库连接管理
- SQL执行和结果处理
- 表结构查询

**app.py**
- Flask路由定义
- API接口实现

### 3.3 数据模型

#### 3.3.1 报表配置表 (report_configs)

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | INTEGER | 主键，自增 |
| name | VARCHAR(200) | 报表名称 |
| description | TEXT | 报表描述 |
| data_source | TEXT | 数据源标识 |
| layout_config | TEXT | 布局配置（JSON格式） |
| query_config | TEXT | 查询配置（JSON格式） |
| created_at | DATETIME | 创建时间 |
| updated_at | DATETIME | 更新时间 |

#### 3.3.2 布局配置结构 (layout_config)

```json
{
  "layout": [
    {
      "i": "widget-1234567890",
      "x": 0,
      "y": 0,
      "w": 12,
      "h": 8
    }
  ],
  "widgets": [
    {
      "i": "widget-1234567890",
      "type": "table",
      "title": "数据表格",
      "x": 0,
      "y": 0,
      "w": 12,
      "h": 8
    }
  ]
}
```

#### 3.3.3 查询配置结构 (query_config)

```json
{
  "table": "users",
  "fields": [
    {
      "name": "id",
      "alias": "用户ID",
      "table": "users",
      "type": "INTEGER"
    },
    {
      "name": "name",
      "alias": "姓名",
      "table": "users",
      "type": "VARCHAR"
    }
  ],
  "filters": [
    {
      "field": "age",
      "operator": ">",
      "value": "25"
    }
  ]
}
```

## 4. API接口设计

### 4.1 报表管理接口

#### 4.1.1 获取报表列表
- **URL**: `GET /api/reports`
- **响应**:
```json
{
  "success": true,
  "data": [
    {
      "id": 1,
      "name": "用户报表",
      "description": "用户信息报表",
      "data_source": "default",
      "created_at": "2024-01-01 10:00:00",
      "updated_at": "2024-01-01 10:00:00"
    }
  ]
}
```

#### 4.1.2 获取报表详情
- **URL**: `GET /api/reports/{report_id}`
- **响应**:
```json
{
  "success": true,
  "data": {
    "id": 1,
    "name": "用户报表",
    "description": "用户信息报表",
    "data_source": "default",
    "layout_config": {...},
    "query_config": {...},
    "created_at": "2024-01-01 10:00:00",
    "updated_at": "2024-01-01 10:00:00"
  }
}
```

#### 4.1.3 创建报表
- **URL**: `POST /api/reports`
- **请求体**:
```json
{
  "name": "用户报表",
  "description": "用户信息报表",
  "data_source": "default",
  "layout_config": {...},
  "query_config": {...}
}
```
- **响应**:
```json
{
  "success": true,
  "data": {
    "id": 1,
    "name": "用户报表",
    ...
  }
}
```

#### 4.1.4 更新报表
- **URL**: `PUT /api/reports/{report_id}`
- **请求体**: 同创建报表
- **响应**: 同创建报表

#### 4.1.5 删除报表
- **URL**: `DELETE /api/reports/{report_id}`
- **响应**:
```json
{
  "success": true,
  "message": "删除成功"
}
```

#### 4.1.6 执行报表查询
- **URL**: `POST /api/reports/execute`
- **请求体**:
```json
{
  "query_config": {
    "tables": ["users"],
    "fields": [
      {
        "table": "users",
        "field": "id",
        "alias": "用户ID"
      }
    ],
    "filters": [...]
  }
}
```
- **响应**:
```json
{
  "success": true,
  "data": [...],
  "columns": ["id", "name", ...],
  "sql": "SELECT users.id AS 用户ID FROM users WHERE ..."
}
```

## 5. 用户界面设计

### 5.1 报表列表页面

**布局结构**:
- 顶部导航栏：显示"报表设计器"标题和"创建报表"按钮
- 主要内容区：报表列表表格
  - 显示：ID、报表名称、描述、数据源、创建时间、更新时间
  - 操作：编辑、删除

### 5.2 报表设计器页面

**布局结构**:
- 左侧边栏（宽度300px）：
  - 报表基本信息表单（名称、描述）
  - 数据源配置区域
    - 数据源选择
    - 数据表选择
    - 字段配置列表
    - 筛选条件配置
  - 组件库
    - 数据表格组件
    - 图表组件
    - 文本组件
  - 操作按钮（保存、预览）
  
- 右侧主设计区：
  - 可拖拽的网格布局区域
  - 组件卡片展示
  - 组件删除功能

### 5.3 组件设计

#### 5.3.1 数据表格组件
- 类型：table
- 默认尺寸：12列宽，8行高
- 功能：展示查询结果数据表格

#### 5.3.2 图表组件
- 类型：chart
- 默认尺寸：6列宽，6行高
- 功能：展示数据图表（待扩展）

#### 5.3.3 文本组件
- 类型：text
- 默认尺寸：6列宽，6行高
- 功能：展示文本内容（待扩展）

## 6. 实现细节

### 6.1 拖拽布局实现

使用react-grid-layout库实现：
- 12列网格系统
- 行高30px
- 组件可拖拽和调整大小
- 布局变化自动保存

### 6.2 SQL生成逻辑

根据查询配置生成SQL语句：
1. 构建SELECT子句：从fields配置中提取字段
2. 构建FROM子句：从tables配置中提取表名
3. 构建WHERE子句：从filters配置中提取筛选条件
4. 构建GROUP BY子句：从group_by配置中提取（当前未实现）
5. 构建ORDER BY子句：从order_by配置中提取（当前未实现）

### 6.3 数据验证

- 报表名称必填验证
- 数据源必选验证
- 表和字段必选验证
- SQL注入防护

### 6.4 错误处理

- API请求错误提示
- SQL执行错误提示
- 数据验证错误提示
- 友好的错误消息展示

## 7. 部署说明

### 7.1 依赖安装

**后端依赖**:
```bash
pip install -r requirements.txt
```

**前端依赖**:
```bash
npm install
```

### 7.2 数据库初始化

数据库表结构会在首次运行时自动创建（通过database_service.py的_init_database方法）。

### 7.3 运行服务

**后端服务**:
```bash
python backend/app.py
# 或使用
run_backend.bat
```

**前端服务**:
```bash
npm run dev
# 或使用
run_frontend.bat
```

### 7.4 访问地址

- 前端应用: http://localhost:8080 (默认)
- 后端API: http://localhost:5000 (默认)
- 报表设计器: http://localhost:8080/reports

## 8. 扩展计划

### 8.1 功能扩展

1. **多数据源支持**
   - 支持MySQL、PostgreSQL等其他数据库
   - 支持数据源管理功能

2. **高级查询功能**
   - 支持多表JOIN查询
   - 支持GROUP BY和聚合函数
   - 支持ORDER BY排序
   - 支持LIMIT分页

3. **组件扩展**
   - 完善图表组件（柱状图、折线图、饼图等）
   - 添加文本组件编辑功能
   - 添加图片组件
   - 添加自定义组件

4. **报表导出**
   - 支持导出为PDF
   - 支持导出为Excel
   - 支持导出为图片

5. **报表分享**
   - 支持报表链接分享
   - 支持报表权限控制

### 8.2 性能优化

1. **查询优化**
   - 添加查询结果缓存
   - 优化SQL查询性能
   - 支持大数据量分页

2. **前端优化**
   - 组件懒加载
   - 虚拟滚动
   - 代码分割

### 8.3 用户体验优化

1. **拖拽体验**
   - 添加组件对齐辅助线
   - 添加组件吸附功能
   - 优化拖拽流畅度

2. **配置体验**
   - 添加字段搜索功能
   - 添加配置模板
   - 添加配置导入导出

## 9. 测试计划

### 9.1 功能测试

- [ ] 报表创建功能测试
- [ ] 报表编辑功能测试
- [ ] 报表删除功能测试
- [ ] 数据源配置测试
- [ ] 字段选择测试
- [ ] 筛选条件测试
- [ ] 拖拽布局测试
- [ ] 报表预览测试
- [ ] 报表保存测试

### 9.2 安全测试

- [ ] SQL注入防护测试
- [ ] 参数验证测试
- [ ] 权限控制测试（待实现）

### 9.3 性能测试

- [ ] 大数据量查询测试
- [ ] 并发请求测试
- [ ] 前端渲染性能测试

## 10. 维护说明

### 10.1 日志记录

- API请求日志
- SQL执行日志
- 错误日志

### 10.2 数据备份

- 定期备份报表配置数据
- 数据库文件备份

### 10.3 版本更新

- 数据库迁移脚本
- 配置兼容性处理

## 11. 总结

本设计说明书详细描述了拖拽报表生成功能的实现方案，包括功能需求、系统架构、API设计、界面设计、实现细节等。该功能为系统提供了强大的可视化报表设计能力，用户可以轻松创建和管理报表，大大提升了系统的易用性和灵活性。

通过模块化的设计和清晰的接口定义，系统具有良好的可扩展性，可以方便地添加新功能和组件类型。同时，通过严格的安全验证和错误处理，确保了系统的稳定性和安全性。

