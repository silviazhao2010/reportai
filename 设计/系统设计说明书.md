# AI报表生成系统设计说明书

## 1. 系统概述

### 1.1 项目背景
AI报表生成系统是一个基于自然语言处理技术的智能报表生成平台，用户可以通过自然语言描述需求，系统自动理解用户意图，将自然语言转换为SQL查询语句，执行数据库查询后生成可视化报表。

### 1.2 系统目标
- 提供自然语言到SQL的转换能力（NL2SQL）
- 支持多种数据可视化图表展示
- 提供简洁友好的用户交互界面
- 实现前后端分离的架构设计

### 1.3 系统范围
本系统为Demo版本，主要实现核心功能：
- 自然语言输入与理解
- NL2SQL转换
- 数据库查询执行
- 报表数据可视化展示

## 2. 系统架构设计

### 2.1 总体架构
系统采用前后端分离架构：
```
┌─────────────────┐
│   前端界面      │  React + Ant Design
│  (用户交互层)   │
└────────┬────────┘
         │ HTTP/HTTPS
         │
┌────────▼────────┐
│   后端API服务   │  Python/Node.js
│  (业务逻辑层)   │
└────────┬────────┘
         │
    ┌────┴────┐
    │         │
┌───▼───┐ ┌──▼────┐
│ NL2SQL│ │数据库 │
│ 引擎  │ │ MySQL │
└───────┘ └───────┘
```

### 2.2 技术架构

#### 2.2.1 前端技术栈
- **框架**: React 17.0.2
- **UI组件库**: Ant Design 4.24.13
- **路由**: React Router DOM 5.3.4
- **HTTP客户端**: Axios 1.8.4
- **图标**: @ant-design/icons 5.3.0
- **构建工具**: Webpack 4.42.0
- **代码规范**: ESLint

#### 2.2.2 后端技术栈（建议）
- **运行环境**: Python 3.8+ / Node.js 14+
- **Web框架**: Flask/FastAPI 或 Express.js
- **NL2SQL引擎**: 
  - 可选方案1: 基于规则模板的NL2SQL转换
  - 可选方案2: 集成开源NL2SQL模型（如SQLova、TypeSQL等）
  - 可选方案3: 调用第三方NL2SQL API服务
- **数据库**: MySQL 5.7+
- **ORM/数据库连接**: SQLAlchemy / Sequelize

## 3. 功能模块设计

### 3.1 前端功能模块

#### 3.1.1 自然语言输入模块
- **功能描述**: 提供文本输入框，接收用户的自然语言查询请求
- **交互设计**: 
  - 输入框支持多行文本输入
  - 提供示例查询提示
  - 支持历史查询记录
- **组件**: Input.TextArea (Ant Design)

#### 3.1.2 查询执行模块
- **功能描述**: 发送查询请求到后端，显示查询状态
- **交互设计**:
  - 查询按钮触发请求
  - Loading状态提示
  - 错误信息提示
- **组件**: Button, Spin, Message (Ant Design)

#### 3.1.3 报表展示模块
- **功能描述**: 展示查询结果，支持多种图表类型
- **图表类型**:
  - 表格展示（Table）
  - 柱状图（Bar Chart）
  - 折线图（Line Chart）
  - 饼图（Pie Chart）
- **组件**: Table, 图表组件（可集成ECharts或Ant Design Charts）

#### 3.1.4 SQL预览模块（可选）
- **功能描述**: 显示系统生成的SQL语句，便于用户理解和调试
- **组件**: Code Editor 或 TextArea（只读模式）

### 3.2 后端功能模块

#### 3.2.1 自然语言理解模块
- **功能描述**: 解析用户输入的自然语言，提取关键信息
- **处理流程**:
  1. 文本预处理（去除停用词、标点符号处理）
  2. 实体识别（表名、字段名、条件值等）
  3. 意图识别（查询类型：SELECT、聚合、排序等）

#### 3.2.2 NL2SQL转换模块
- **功能描述**: 将自然语言转换为标准SQL语句
- **转换规则**:
  - 表名映射：维护自然语言表名到数据库表名的映射
  - 字段映射：维护自然语言字段到数据库字段的映射
  - SQL模板：根据查询类型选择对应的SQL模板
  - 条件解析：解析WHERE子句条件
  - 聚合函数识别：COUNT、SUM、AVG、MAX、MIN等

#### 3.2.3 SQL执行模块
- **功能描述**: 执行生成的SQL语句，查询数据库
- **安全措施**:
  - SQL注入防护
  - 只读权限限制
  - 查询超时控制
  - 结果集大小限制

#### 3.2.4 数据返回模块
- **功能描述**: 格式化查询结果，返回给前端
- **返回格式**: JSON格式
  ```json
  {
    "success": true,
    "data": [...],
    "sql": "SELECT ...",
    "columns": [...],
    "message": "查询成功"
  }
  ```

## 4. 数据库设计

### 4.1 示例数据库结构
为Demo系统设计一个示例数据库，包含常见的业务表：

#### 4.1.1 用户表（users）
```sql
CREATE TABLE users (
    id INT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(100),
    age INT,
    city VARCHAR(50),
    created_at DATETIME
);
```

#### 4.1.2 订单表（orders）
```sql
CREATE TABLE orders (
    id INT PRIMARY KEY AUTO_INCREMENT,
    user_id INT,
    product_name VARCHAR(100),
    amount DECIMAL(10,2),
    order_date DATE,
    status VARCHAR(20),
    FOREIGN KEY (user_id) REFERENCES users(id)
);
```

#### 4.1.3 产品表（products）
```sql
CREATE TABLE products (
    id INT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(100),
    category VARCHAR(50),
    price DECIMAL(10,2),
    stock INT
);
```

### 4.2 元数据管理
维护自然语言到数据库的映射关系：

#### 4.2.1 表名映射表（table_mapping）
```sql
CREATE TABLE table_mapping (
    id INT PRIMARY KEY AUTO_INCREMENT,
    natural_name VARCHAR(100),  -- 自然语言表名
    db_table_name VARCHAR(100), -- 数据库表名
    description TEXT
);
```

#### 4.2.2 字段映射表（column_mapping）
```sql
CREATE TABLE column_mapping (
    id INT PRIMARY KEY AUTO_INCREMENT,
    table_id INT,
    natural_name VARCHAR(100),  -- 自然语言字段名
    db_column_name VARCHAR(100), -- 数据库字段名
    data_type VARCHAR(50),
    FOREIGN KEY (table_id) REFERENCES table_mapping(id)
);
```

## 5. API接口设计

### 5.1 查询接口

#### 5.1.1 自然语言查询
- **接口路径**: `/api/query`
- **请求方法**: POST
- **请求参数**:
  ```json
  {
    "query": "查询所有用户的订单总金额",
    "showSql": true  // 是否返回生成的SQL
  }
  ```
- **响应参数**:
  ```json
  {
    "success": true,
    "data": [
      {
        "user_id": 1,
        "total_amount": 1500.00
      }
    ],
    "sql": "SELECT user_id, SUM(amount) as total_amount FROM orders GROUP BY user_id",
    "columns": ["user_id", "total_amount"],
    "message": "查询成功"
  }
  ```

#### 5.1.2 获取数据库表列表
- **接口路径**: `/api/tables`
- **请求方法**: GET
- **响应参数**:
  ```json
  {
    "success": true,
    "data": [
      {
        "name": "users",
        "naturalName": "用户表",
        "description": "用户信息表"
      }
    ]
  }
  ```

#### 5.1.3 获取表字段信息
- **接口路径**: `/api/tables/:tableName/columns`
- **请求方法**: GET
- **响应参数**:
  ```json
  {
    "success": true,
    "data": [
      {
        "name": "id",
        "naturalName": "编号",
        "type": "INT",
        "description": "主键ID"
      }
    ]
  }
  ```

## 6. 核心算法设计

### 6.1 NL2SQL转换流程

```
自然语言输入
    ↓
文本预处理（分词、去停用词）
    ↓
实体识别（NER）
    ├─ 表名识别
    ├─ 字段名识别
    └─ 条件值识别
    ↓
意图识别
    ├─ 查询类型（SELECT、聚合、排序）
    ├─ 聚合函数（COUNT、SUM、AVG等）
    └─ 排序方向（ASC、DESC）
    ↓
SQL模板选择
    ↓
SQL生成
    ├─ SELECT子句构建
    ├─ FROM子句构建
    ├─ WHERE子句构建
    ├─ GROUP BY子句构建
    └─ ORDER BY子句构建
    ↓
SQL验证与优化
    ↓
返回SQL语句
```

### 6.2 实体识别规则（示例）

#### 6.2.1 表名识别
- 关键词匹配：用户、订单、产品等
- 映射表查询：从table_mapping表获取对应关系

#### 6.2.2 字段识别
- 关键词匹配：金额、数量、日期、名称等
- 映射表查询：从column_mapping表获取对应关系

#### 6.2.3 条件识别
- 时间条件：今天、昨天、本周、本月等
- 数值条件：大于、小于、等于等
- 文本条件：包含、等于等

## 7. 前端页面设计

### 7.1 主页面布局
```
┌─────────────────────────────────────┐
│          AI报表生成系统              │
├─────────────────────────────────────┤
│                                     │
│  自然语言输入框                      │
│  ┌─────────────────────────────┐   │
│  │ 请输入您的查询需求...        │   │
│  │                              │   │
│  └─────────────────────────────┘   │
│                                     │
│  [查询] [清空] [示例]               │
│                                     │
├─────────────────────────────────────┤
│  SQL预览（可选）                     │
│  ┌─────────────────────────────┐   │
│  │ SELECT ...                   │   │
│  └─────────────────────────────┘   │
├─────────────────────────────────────┤
│  报表展示区域                        │
│  ┌─────────────────────────────┐   │
│  │  [表格/图表]                │   │
│  │                            │   │
│  └─────────────────────────────┘   │
└─────────────────────────────────────┘
```

### 7.2 页面路由设计
- `/` - 主查询页面
- `/history` - 查询历史（可选）
- `/help` - 使用帮助（可选）

## 8. 安全设计

### 8.1 SQL注入防护
- 使用参数化查询（Prepared Statement）
- SQL白名单验证
- 禁止执行DDL和DML语句（仅允许SELECT）

### 8.2 访问控制
- API接口鉴权（可选）
- 请求频率限制
- IP白名单（可选）

### 8.3 数据安全
- 敏感数据脱敏
- 查询结果集大小限制
- 查询超时控制

## 9. 错误处理

### 9.1 前端错误处理
- 网络请求错误提示
- SQL执行失败提示
- 数据格式错误提示

### 9.2 后端错误处理
- 自然语言理解失败：返回友好提示
- SQL生成失败：返回错误原因
- 数据库连接失败：返回系统错误
- SQL执行失败：返回SQL错误信息

## 10. 部署方案

### 10.1 开发环境
- 前端：Webpack Dev Server（端口：3000）
- 后端：开发服务器（端口：5000）
- 数据库：本地MySQL

### 10.2 生产环境（建议）
- 前端：Nginx静态资源服务
- 后端：Gunicorn/uWSGI（Python）或PM2（Node.js）
- 数据库：MySQL主从或云数据库

### 10.3 Docker部署（可选）
- 前端容器
- 后端容器
- 数据库容器
- Docker Compose编排

## 11. 开发计划

### 11.1 第一阶段：基础功能
- [ ] 前端页面搭建
- [ ] 后端API框架搭建
- [ ] 数据库设计与初始化
- [ ] 基础NL2SQL转换（规则模板）

### 11.2 第二阶段：核心功能
- [ ] NL2SQL转换优化
- [ ] 报表可视化展示
- [ ] 错误处理完善
- [ ] SQL预览功能

### 11.3 第三阶段：优化增强
- [ ] 查询历史记录
- [ ] 图表类型扩展
- [ ] 性能优化
- [ ] 用户体验优化

## 12. 测试计划

### 12.1 单元测试
- NL2SQL转换逻辑测试
- SQL生成准确性测试
- API接口测试

### 12.2 集成测试
- 前后端联调测试
- 数据库查询测试
- 端到端流程测试

### 12.3 测试用例示例
- 简单查询：查询所有用户
- 条件查询：查询年龄大于30的用户
- 聚合查询：统计每个城市的用户数量
- 排序查询：按订单金额降序排列
- 复杂查询：多表关联查询

## 13. 附录

### 13.1 术语表
- **NL2SQL**: Natural Language to SQL，自然语言转SQL
- **NER**: Named Entity Recognition，命名实体识别
- **ORM**: Object-Relational Mapping，对象关系映射

### 13.2 参考资料
- React官方文档
- Ant Design组件库文档
- MySQL官方文档
- NL2SQL相关论文和开源项目

---

**文档版本**: v1.0  
**编写日期**: 2024年  
**最后更新**: 2024年

